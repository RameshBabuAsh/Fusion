{% extends 'examination/base.html' %}

{% block sidetabmenu %}
<div class="ui medium fluid vertical pointing menu" style="max-width: 320px;">
  <a class="active item" href="{% url 'examination:submitGrades' %}"><B>Submit</B>
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:updateGrades' %}">Verify
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:announcement' %}">Announcement
    <i class="right floated chevron right icon"></i>
  </a>
  <a class="item" href="{% url 'examination:generate_transcript_form' %}">Generate Transcript
    <i class="right floated chevron right icon"></i>
  </a>
</div>
{% endblock %}

{% block content %}
<h1>Submit Results</h1>
<br />

<div style="display: flex; flex-direction: column; gap: 30px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 50px; align-items: center;">
        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 500px;">
            <label for="course-select" style="font-weight: bold;">Course</label>
            <div style="position: relative; display: inline-block; width: 100%; cursor: pointer;">
                <select id="course-select" name="course" style="padding: 12px; font-size: 1rem; min-height: 50px; width: 100%; background: white; outline: none; transition: all 0.3s ease-in-out; cursor: pointer;">
                    <option value="">Select Course</option>
                    <option value="">No Courses Available</option> <!-- Populated dynamically -->
                </select>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 300px;">
            <label for="year-select" style="font-weight: bold;">Academic Year</label>
            <select id="year-select" name="year" onchange="fetchCoursesByYear(this.value)" style="padding: 12px; font-size: 1rem; min-height: 50px; width: 100%; background: white;  appearance: none; outline:none; cursor: pointer;">
              
                {% for working_year in working_years %}
                <option value="{{ working_year.working_year }}">{{ working_year.working_year }}</option>
                {% empty %}
                <option value="">No Years Available</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div style="margin-left: 10px; display: flex; gap: 20px;">
        <input type="file" id="csv-file" accept=".csv" style="margin-right: 20px;">
        <button class="ui primary button" style="cursor: pointer; padding: 10px 20px;" onclick="upload()">Upload Results</button>
    </div>

    <div style="margin-left: 10px; display: flex; gap: 20px;">
        <button class="ui primary button" style="cursor: pointer; padding: 10px 20px;" onclick="dwn_temp()">Download Template</button>
    </div>
</div>

<script>
    // Function to fetch courses based on the selected year
    function fetchCoursesByYear(selectedYear) {
        if (!selectedYear) {
            return;
        }

        $.ajax({
            url: '/examination/submitGrades/',  // Replace with your API endpoint
            type: 'GET',
            data: { academic_year: selectedYear },  // Send the selected year as a parameter
            success: function(response) {
                let courseSelect = document.getElementById('course-select');
                courseSelect.innerHTML = ''; // Clear the current courses dropdown
                
                // Check if there are any courses in the response
                if (response.courses && response.courses.length > 0) {
                    response.courses.forEach(function(course) {
                        let option = document.createElement('option');
                        option.value = course.id;
                        option.text = `${course.code} - ${course.name}`;
                        courseSelect.appendChild(option);
                    });
                } else {
                    // If no courses are available, show a placeholder
                    let noCoursesOption = document.createElement('option');
                    noCoursesOption.text = 'No Courses Available';
                    courseSelect.appendChild(noCoursesOption);
                }
            },
            error: function(xhr, status, error) {
                alert('Failed to fetch courses. Please try again.');
            }
        });
    }

    function upload() {
        let selectedCourse = document.getElementById('course-select').value;
        let selectedYear = document.getElementById('year-select').value;
        
        let fileInput = document.getElementById('csv-file');
        let file = fileInput.files[0];
        
        if (!selectedCourse || !selectedYear || !file) {
            alert('Please select course, year, and upload a CSV file.');
            return;
        }
        if (!confirm('Are you sure you want to submit? This cannot be undone')) {
            return;
        }

        var formData = new FormData();
        formData.append('course_id', selectedCourse);
        formData.append('academic_year', selectedYear);
        formData.append('csv_file', file);

        $.ajax({
            url: '/examination/upload_grades/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.redirect_url) {
                    alert(response.message);
                    window.location.href = response.redirect_url;
                }
            },
            error: function(xhr, status, error) {
                if (xhr.responseJSON && xhr.responseJSON.redirect_url) {
                    window.location.href = xhr.responseJSON.redirect_url;
                } else {
                    var errorMessage = xhr.responseJSON ? xhr.responseJSON.error : 'An unexpected error occurred.';
                    alert(errorMessage);
                }
            }
        });
    }

    function dwn_temp() {
        let selectedCourse = document.getElementById('course-select').value;
        let selectedYear = document.getElementById('year-select').value;
    
        if (!selectedCourse || !selectedYear) {
            alert("Please select both course and year.");
            return;
        }

        $.ajax({
            url: `/examination/download_template/`,
            type: 'GET',
            data: { 
                course: selectedCourse, 
                year: selectedYear 
            },
            xhrFields: {
                responseType: 'blob' // Set response type to 'blob' for file download
            },
            success: function (data, status, xhr) {
                // Extract the filename from the response headers
                const disposition = xhr.getResponseHeader('Content-Disposition');
                const matches = /filename="([^"]+)"/.exec(disposition);
                const filename = (matches != null && matches[1]) ? matches[1] : 'template.csv';
        
                // Create a link element to trigger download
                const link = document.createElement('a');
                const url = window.URL.createObjectURL(data);
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
        
                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(link);
            },
            error: function (xhr, status, error) {
                // Handle errors more gracefully
                try {
                    // Check if response is JSON
                    const errorResponse = xhr.responseJSON || { error: 'Unknown error occurred' };
                    alert(`Error: ${errorResponse.error}`);
                } catch (e) {
                    // If not JSON, show generic error message
                    alert('An error occurred while downloading the file.');
                }
            }
        });
        
    }
    
</script>

{% endblock %}
